{% extends "_base.html" %}

{% block title %}{{ forum.name }} » {{ thread.name }}{% endblock %}

{% block content %}
    <h1><a href="{{url_for('index')}}">RHForum</a> » <a href="{{forum.url}}">{{forum.name}}</a> » <a href="{{thread.url}}">{{thread.name}}</a></h1>
    {% if g.user.admin %}
        <div class="thread-controls">
            <form action="{{thread.url}}/set" method="POST">
                {% if not thread.pinned %}
                    <input type="submit" name="pin" value="Přišpendlit">
                {% else %}
                    <input type="submit" name="unpin" value="Odšpendlit">
                {% endif %}
                {% if not thread.locked %}
                    <input type="submit" name="lock" value="Zamknout">
                {% else %}
                    <input type="submit" name="unlock" value="Odemknout">
                {% endif %}
            </form>
        </div>
    {% endif %}
    {% if thread.wiki_article %}
        <div class="thread-article">
            <div class="thread-desc">
                Diskuze k wiki článku <a href="htp://retroherna.cz/wiki/doku.php?id={{thread.wiki_article}}">{{thread.wiki_article}}</a>
            </div>
            <div class="thread-article-text">
                {% if article %}
                    {{ article | safe }}
                {% elif doku_error %}
                    <div class="article-error">
                        Selhalo získávání článku z DokuWiki: {{doku_error}}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
    <div class="posts">
        {% for post in posts %}
            <div class="post">
                <div id="post-{{post.id}}" class="post-fragment"></div>
                {% if post.original_id %}
                    <div id="post-{{post.original_id}}" class="post-fragment"></div>
                {% endif %}
                {% if loop.last %}
                    <div id="post-latest" class="post-fragment"></div>
                {% endif %}
                <div class="post-sidebar">
                    <div class="post-author"><a href="{{post.author.url}}">{{ post.author.name }}</a></div>
                    <div class="post-author-posts">{{ txt_posts(post.author.num_posts) }}</div>
                    <div class="post-avatar">
                        {% if post.author.avatar_url %}
                            <img src="{{post.author.avatar_url}}" class="avatar">
                        {% endif %}
                    </div>
                </div>
                <div class="post-contents">
                    <div class="post-data">
                        {% if ((post.author == g.user) or g.user.admin) and post != edit_post %}
                            <a href="{{thread.url}}/edit/{{post.id}}#post-{{post.id}}">Upravit</a> &bull;
                        {% endif %}
                        <a href="{{post.url}}" class="permalink">{{ ago(post.timestamp) }}</a>
                        {% if not last_read_timestamp or last_read_timestamp < post.timestamp %}
                            <div class="new-icon">NEW</div>
                        {% endif %}
                    </div>
                    <div class="post-text">
                        {% if post != edit_post %}
                            <p>{{ post.text | clean | safe | replace("\n", "\n<p>"|safe) | safe | urlize }}
                            {% if post.editstamp %}
                                <div class="post-edited">
                                    Naposledy upraveno {% if post.editor != post.user and post.editor.admin %}moderátorem{% endif %} {{ ago(post.editstamp) }} {% if g.user.admin %}({{post.editor.name}}){% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <form method="POST">
                                {% if edit_thread %}
                                    <div>{{ form.name }}</div>
                                    <div>Fórum: {{ form.forum_id }}</div>
                                {% endif %}
                                <div>{{ form.text }}</div>
                                {% if form.wiki_article %}
                                    <div>
                                        Wiki článek: {{ form.wiki_article }}
                                    </div>
                                {% endif %}
                                <div>
                                    {{ form.submit }}
                                    {% if form.delete %}
                                        {{ form.delete(class_="delete-button") }}
                                        {% if edit_thread %}
                                            (pro smazání celého tématu přesuňte do koše)
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="clear"></div>
    {% if g.user and not edit_post and form %}
        <h2>Nový příspěvek</h2>
        {% if thread.locked %}
            <div class="locked-text">
                Téma je zamčené pro běžné uživatele.
            </div>
        {% endif %}
        <form method="POST">
            <div class="post">
                <div class="post-sidebar">
                    <div class="post-author"><a href="{{ g.user.url }}">{{ g.user.name }}</a></div>
                    <div class="post-avatar">
                        {% if g.user.avatar_url %}
                            <img src="{{g.user.avatar_url}}" class="avatar">
                        {% endif %}
                    </div>
                </div>
                    <div class="post-contents">
                        <div class="post-data">
                            {{ ago(now) }}
                        </div>
                        <div class="post-text">
                            {{ form.text }}
                        </div>
                        <div class="new-post-controls">
                            {{ form.submit }}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    {% endif %}
    {% if thread.locked and not g.user.admin %}
        <div class="locked-text">
            Téma je zamčené.
        </div>
    {% endif %}
{% endblock %}
